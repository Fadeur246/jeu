<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sokoban ‚Äî Casse-t√™te | Gameur Fadeur</title>
  <style>
    :root { color-scheme: dark; }
    html,body{height:100%;margin:0;background:#0e0f13;color:#e8e8e8;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif}
    .wrap{min-height:100%;display:flex;flex-direction:column}
    header{padding:12px 16px;background:#151720;box-shadow:0 2px 10px rgba(0,0,0,.4);display:flex;gap:10px;align-items:center}
    header h1{margin:0;font-size:18px;letter-spacing:.2px}
    .btn{background:#2a2f3a;color:#e8e8e8;border:1px solid #3a4050;padding:8px 12px;border-radius:12px;cursor:pointer;text-decoration:none;font-weight:700}
    .btn:hover{background:#343b49}
    .spacer{flex:1}
    .hud{display:flex;flex-wrap:wrap;gap:10px;align-items:center;padding:10px 16px}
    .tag{background:#1c202a;border:1px solid #2a2f3a;padding:6px 10px;border-radius:10px;font-variant-numeric:tabular-nums}
    .game{flex:1;display:flex;justify-content:center;align-items:center;padding:12px}
    canvas{background:#0c0f15;border:1px solid #232839;border-radius:18px;box-shadow:0 10px 30px rgba(0,0,0,.25);touch-action:none;max-width:95vw;max-height:72vh}
    .panel{max-width:980px;margin:0 auto 18px;padding:0 16px}
    .rules{background:#10131a;border:1px solid #232839;border-radius:14px;padding:14px 16px;font-size:14px;line-height:1.6}
    .warn{color:#ffd36b}
    footer{text-align:center;opacity:.6;font-size:12px;padding:12px 0 18px}
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <a class="btn" href="./index.html">üè† Accueil</a>
    <h1>üì¶ Sokoban ‚Äî Casse-t√™te</h1>
    <div class="spacer"></div>
    <button class="btn" id="btnPrev">‚ü®‚ü® Pr√©c.</button>
    <select class="btn" id="levelSelect" title="Niveau"></select>
    <button class="btn" id="btnNext">Suiv. ‚ü©‚ü©</button>
    <button class="btn" id="btnUndo" title="Annuler (Z)">‚Ü∂ Annuler</button>
    <button class="btn" id="btnReset" title="Recommencer (R)">‚Ü∫ R√©initialiser</button>
  </header>

  <div class="hud panel">
    <div class="tag">Niveau : <span id="labLevel">1</span></div>
    <div class="tag">Coups : <span id="labMoves">0</span> <span id="labBest" class="muted"></span></div>
    <div class="tag">Caisses/But : <span id="labCounts">0/0</span></div>
    <div class="tag warn" id="labWarn" style="display:none">‚ö† caisse coinc√©e en coin (niveau perdu si non sur ‚óè)</div>
  </div>

  <div class="game">
    <canvas id="cv" width="760" height="760"></canvas>
  </div>

  <div class="panel">
    <div class="rules">
      <b>Contr√¥les :</b> fl√®ches / ZQSD / WASD. Mobile : glisser. ‚Äî
      <b>R</b> = r√©initialiser, <b>Z</b> / Retour = annuler. <br>
      Objectif : toutes les caisses ‚ñ£ sur les emplacements ‚óè. Astuce : √©viter de pousser une caisse dans un coin (sauf si c‚Äôest un ‚óè).
    </div>
  </div>

  <footer>¬© Gameur Fadeur ‚Äî Sokoban</footer>
</div>

<script>
(function(){
  // # mur, espace vide, . but, $ caisse, * caisse sur but, @ joueur, + joueur sur but
  // Pack v√©rifi√© : caisses == buts, d√©parts sans caisse coinc√©e en coin non-but
  const LEVELS = [
    // 1
    [
      "########",
      "#      #",
      "#  @   #",
      "#  $   #",
      "#  .   #",
      "#      #",
      "########"
    ],
    // 2
    [
      "#########",
      "#   .   #",
      "#   $   #",
      "#   @   #",
      "#       #",
      "#       #",
      "#########"
    ],
    // 3
    [
      "#########",
      "#  . .  #",
      "#  $$   #",
      "#   @   #",
      "#       #",
      "#       #",
      "#########"
    ],
    // 4
    [
      "##########",
      "#   . .  #",
      "# $$$    #",
      "#   @    #",
      "#   .    #",
      "#        #",
      "##########"
    ],
    // 5
    [
      "###########",
      "#   . .   #",
      "#   $$    #",
      "# @   $   #",
      "#     .   #",
      "#     $ . #",
      "###########"
    ],
   // 6 ‚Äî corrig√© (4 caisses / 4 buts)
    [
      "###########",
      "#  .   .  #",
      "# ### ### #",
      "#  $ @ $  #",
      "#   $ $   #",
      "#  .   .  #",
      "###########"
    ],

    // 7
    [
      "###########",
      "# .   # . #",
      "#  $  # $ #",
      "#  #  #   #",
      "#  #  #   #",
      "# @   #   #",
      "###########"
    ],
    // 8
    [
      "###########",
      "# . .     #",
      "# $$$$    #",
      "#   @     #",
      "#   ###   #",
      "#    .    #",
      "###########"
    ],
    // 9
    [
      "############",
      "# .   .    #",
      "# $$#$$    #",
      "#  #@ #    #",
      "#  ###     #",
      "#   .  .   #",
      "############"
    ],
    // 10
    [
      "############",
      "# ..   .   #",
      "# $$ ###   #",
      "#  $   #   #",
      "# @    #   #",
      "#   .  ### #",
      "############"
    ],
    // 11
    [
      "#############",
      "#  .   .    #",
      "#  $$#$$    #",
      "# @#   #    #",
      "#  ### #    #",
      "#   .  #  . #",
      "#############"
    ],
    // 12
    [
      "#############",
      "#  . . .    #",
      "#  $$$$$    #",
      "#  #   #    #",
      "#  # @ #    #",
      "#  ### #   .#",
      "#############"
    ],
    // 13
    [
      "##############",
      "# ..   ..    #",
      "# $$ ### $$  #",
      "#  $  @  $   #",
      "#     #   .  #",
      "#     ###   .#",
      "##############"
    ],
    // 14
    [
      "##############",
      "#  .  .  .   #",
      "#  $$ $$ $   #",
      "#   # @ #    #",
      "#   #   # .  #",
      "#   #####   .#",
      "##############"
    ],
    // 15
    [
      "###############",
      "#  . . . .    #",
      "#  $$$$$$$    #",
      "#  #  @  #    #",
      "#  #     #  . #",
      "#  ### ###   .#",
      "###############"
    ],
    // 16 ‚Äî bonus
    [
      "################",
      "#  .  #    .  #",
      "# $$# # $$##  #",
      "#  @  #   ##  #",
      "#    .#   ##  #",
      "#  .  #  $$   #",
      "#      #   .  #",
      "################"
    ],
    // 17 ‚Äî bonus
    [
      "################",
      "# ..   #   ..  #",
      "# $$ # ### $$  #",
      "#  @ #     $   #",
      "#    # ###  $  #",
      "#    #   #     #",
      "#    #####     #",
      "################"
    ],
    // 18 ‚Äî bonus
    [
      "#################",
      "# ...   #   ... #",
      "# $$$ # # # $$$ #",
      "#  @  #   #     #",
      "#     ### ###   #",
      "#   $     $     #",
      "#   $     $     #",
      "#################"
    ],
    // 19 ‚Äî bonus
    [
      "#################",
      "# .  ### ###  . #",
      "# $$  #   #  $$ #",
      "#  #  # @ #  #  #",
      "#  #  ### ###  #",
      "#  .     $    .#",
      "#     $$   $$  #",
      "#################"
    ],
    // 20 ‚Äî bonus
    [
      "##################",
      "# ....   ##   ....#",
      "# $$$$   ##   $$$$#",
      "#   @         $   #",
      "#  ###  # #  ###  #",
      "#   $   # #   $   #",
      "# ....   #   .... #",
      "##################"
    ]
  ];

  // --- Mod√®le & HUD
  let W=0,H=0; let walls=[], goals=[]; let boxes=new Set(); let player={x:0,y:0};
  let moves=0; let undo=[]; let best=null; let levelIndex=0;

  const cv=document.getElementById('cv'); const ctx=cv.getContext('2d');
  const labLevel=document.getElementById('labLevel'); const labMoves=document.getElementById('labMoves'); const labBest=document.getElementById('labBest');
  const labCounts=document.getElementById('labCounts'); const labWarn=document.getElementById('labWarn');
  const sel=document.getElementById('levelSelect');

  const DIRS={ArrowUp:[0,-1],ArrowDown:[0,1],ArrowLeft:[-1,0],ArrowRight:[1,0],w:[0,-1],s:[0,1],a:[-1,0],d:[1,0],z:[0,-1],q:[-1,0]};

  function idx(x,y){ return y*W+x; }
  function parseLevel(arr){
    H=arr.length; W=Math.max(...arr.map(r=>r.length));
    walls=new Array(W*H).fill(false); goals=new Array(W*H).fill(false); boxes.clear(); player={x:0,y:0};
    for(let y=0;y<H;y++){
      const row=arr[y].padEnd(W,' ');
      for(let x=0;x<W;x++){
        const ch=row[x]; const k=idx(x,y);
        if(ch==='#') walls[k]=true;
        else if(ch==='.') goals[k]=true;
        else if(ch==='$') boxes.add(k);
        else if(ch==='*'){ boxes.add(k); goals[k]=true; }
        else if(ch==='@'){ player={x,y}; }
        else if(ch==='+'){ player={x,y}; goals[k]=true; }
      }
    }
    const bc=boxes.size, gc=goals.reduce((a,b)=>a+(b?1:0),0);
    labCounts.textContent=`${bc}/${gc}`;
  }

  function loadLevel(i){ levelIndex=i; parseLevel(LEVELS[i]); moves=0; undo=[]; best=loadBest(i); updateHUD(); sel.value=String(i); fitCanvas(); draw(); checkCornerWarning(); }
  function updateHUD(){ labLevel.textContent=levelIndex+1; labMoves.textContent=moves; labBest.textContent=best!=null?` (meilleur: ${best})`:''; }

  // Best local
  const LS='sokoban_best_v1';
  function loadBest(i){ try{ const o=JSON.parse(localStorage.getItem(LS)||'{}'); return (i in o)? o[i] : null; }catch(_){ return null; } }
  function saveBest(i,val){ try{ const o=JSON.parse(localStorage.getItem(LS)||'{}'); if(!(i in o) || val<o[i]){ o[i]=val; localStorage.setItem(LS, JSON.stringify(o)); } }catch(_){} }

  // D√©placements
  function move(dx,dy){
    const nx=player.x+dx, ny=player.y+dy; if(nx<0||ny<0||nx>=W||ny>=H) return; const k=idx(nx,ny); if(walls[k]) return;
    const pk=idx(player.x,player.y);
    if(boxes.has(k)){
      const nnx=nx+dx, nny=ny+dy; if(nnx<0||nny<0||nnx>=W||nny>=H) return; const kk=idx(nnx,nny); if(walls[kk]||boxes.has(kk)) return;
      undo.push({type:'push', from:pk, to:k, boxFrom:k, boxTo:kk}); boxes.delete(k); boxes.add(kk); player={x:nx,y:ny};
    } else {
      undo.push({type:'step', from:pk, to:k}); player={x:nx,y:ny};
    }
    moves++; updateHUD(); draw(); checkWin(); checkCornerWarning();
  }

  function undoOne(){
    const a=undo.pop(); if(!a) return;
    if(a.type==='step'){ player={x:(a.from%W), y:Math.floor(a.from/W)}; }
    else if(a.type==='push'){ player={x:(a.from%W), y:Math.floor(a.from/W)}; boxes.delete(a.boxTo); boxes.add(a.boxFrom); }
    moves=Math.max(0,moves-1); updateHUD(); draw(); checkCornerWarning();
  }

  // Alerte: caisse en coin non-but
  function cornerDead(k){
    const x=k%W, y=(k/W)|0;
    const up = y>0 && walls[idx(x,y-1)];
    const down = y<H-1 && walls[idx(x,y+1)];
    const left = x>0 && walls[idx(x-1,y)];
    const right = x<W-1 && walls[idx(x+1,y)];
    return ((up||down) && (left||right)) && !goals[k];
  }
  function checkCornerWarning(){
    for(const b of boxes){ if(cornerDead(b)){ labWarn.style.display=''; return; } }
    labWarn.style.display='none';
  }

  function checkWin(){
    for(const b of boxes){ if(!goals[b]) return; }
    if(best==null||moves<best){ best=moves; saveBest(levelIndex,moves); updateHUD(); }
    setTimeout(()=>{ if(levelIndex<LEVELS.length-1){ if(confirm('Bravo ! Niveau r√©ussi. Passer au suivant ?')) loadLevel(levelIndex+1); } else { alert('Magnifique ! Tous les 20 niveaux sont termin√©s.'); } }, 60);
  }

  // Rendu
  function draw(){
    const pad=16; const cell=Math.floor(Math.min((cv.width-2*pad)/W,(cv.height-2*pad)/H));
    const ox=Math.floor((cv.width-cell*W)/2); const oy=Math.floor((cv.height-cell*H)/2);
    ctx.clearRect(0,0,cv.width,cv.height);
    ctx.fillStyle='#0c0f15'; ctx.fillRect(0,0,cv.width,cv.height);

    for(let y=0;y<H;y++){
      for(let x=0;x<W;x++){
        const k=idx(x,y); const X=ox+x*cell, Y=oy+y*cell;
        ctx.fillStyle = '#10131a'; ctx.strokeStyle='#232839'; ctx.lineWidth=2;
        roundRect(X+2,Y+2,cell-4,cell-4,10); ctx.fill(); ctx.stroke();

        if(walls[k]){ ctx.fillStyle='#1b202b'; ctx.fillRect(X+cell*0.12, Y+cell*0.12, cell*0.76, cell*0.76); continue; }
        if(goals[k]){ ctx.strokeStyle='#4fd486'; ctx.lineWidth=Math.max(2,cell*0.08); ctx.beginPath(); ctx.arc(X+cell/2, Y+cell/2, cell*0.28, 0, Math.PI*2); ctx.stroke(); }
        if(boxes.has(k)){
          const on=goals[k];
          ctx.fillStyle= on? '#7bff9c' : '#bda7ff';
          ctx.strokeStyle= on? '#c9ffdf' : '#dcd2ff';
          roundRect(X+cell*0.18, Y+cell*0.18, cell*0.64, cell*0.64, 10); ctx.fill(); ctx.lineWidth=2; ctx.stroke();
        }
      }
    }
    const X=ox+player.x*cell, Y=oy+player.y*cell;
    ctx.fillStyle='#ff3b4d'; ctx.beginPath(); ctx.arc(X+cell/2, Y+cell/2, cell*0.28, 0, Math.PI*2); ctx.fill();
    ctx.fillStyle='#ffc0c6'; ctx.beginPath(); ctx.arc(X+cell/2, Y+cell/2, cell*0.12, 0, Math.PI*2); ctx.fill();
  }

  function roundRect(x,y,w,h,r){ ctx.beginPath(); ctx.moveTo(x+r,y); ctx.arcTo(x+w,y,x+w,y+h,r); ctx.arcTo(x+w,y+h,x,y+h,r); ctx.arcTo(x,y+h,x,y,r); ctx.arcTo(x,y,x+w,y,r); ctx.closePath(); }

  // Entr√©es
  window.addEventListener('keydown', (e)=>{
    if(e.key==='r'||e.key==='R'){ loadLevel(levelIndex); return; }
    if(e.key==='z'||e.key==='Z'||e.key==='Backspace'){ undoOne(); return; }
    const d=DIRS[e.key]; if(!d) return; e.preventDefault(); move(d[0],d[1]);
  });
  let t0=null; cv.addEventListener('touchstart',(e)=>{ const t=e.touches[0]; t0={x:t.clientX,y:t.clientY}; },{passive:true});
  cv.addEventListener('touchend',(e)=>{ if(!t0) return; const t=e.changedTouches[0]; const dx=t.clientX-t0.x, dy=t.clientY-t0.y; t0=null; if(Math.hypot(dx,dy)<12) return; if(Math.abs(dx)>Math.abs(dy)) move(dx>0?1:-1,0); else move(0,dy>0?1:-1); });

  document.getElementById('btnReset').addEventListener('click',()=>loadLevel(levelIndex));
  document.getElementById('btnUndo').addEventListener('click',()=>undoOne());
  document.getElementById('btnPrev').addEventListener('click',()=>{ if(levelIndex>0) loadLevel(levelIndex-1); });
  document.getElementById('btnNext').addEventListener('click',()=>{ if(levelIndex<LEVELS.length-1) loadLevel(levelIndex+1); });

  function populateSelect(){ sel.innerHTML=''; LEVELS.forEach((_,i)=>{ const o=document.createElement('option'); o.value=i; o.textContent=`Niveau ${i+1}`; sel.appendChild(o); }); sel.addEventListener('change',()=>loadLevel(Number(sel.value))); }

  function fitCanvas(){ const dpr=Math.min(2,window.devicePixelRatio||1); const Wcss=Math.min(760, Math.floor(window.innerWidth*0.95)); const Hcss=Math.min(760, Math.floor(window.innerHeight*0.72)); cv.width=Math.floor(Wcss*dpr); cv.height=Math.floor(Hcss*dpr); ctx.setTransform(dpr,0,0,dpr,0,0); draw(); }
  window.addEventListener('resize', fitCanvas);

  function boot(){ populateSelect(); loadLevel(0); fitCanvas(); }
  boot();
})();
</script>
</body>
</html>


